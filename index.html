<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Live Coach for Super Metroid</title>
    </head>
    <body>
        <link rel="stylesheet" href="../style.css" />
        <main>
            <div style="max-width:900px;margin:24px auto;text-align:center;">
                <h1>Live Coach / SNES Emulator</h1>
                <p id="status">Loading emulator...</p>
                <snes-emulator id="emulator" rom-url="../assets/Super Metroid.sfc" rom-name="Super Metroid"></snes-emulator>
                <controller-mapping></controller-mapping>                
            </div>
        </main>

        <!-- Imported Custom Tag Scripts -->
        <script type="module" src="../tag-scripts/snes-emulator.js"></script>
        <script type="module" src="../tag-scripts/controller-mapping.js"></script>
        <!-- Main Script -->
        <script type="module">
            // Minimal initializer: wait for the custom element to be defined, then attach safe handlers.
            const statusEl = document.getElementById('status');
            const emuEl = document.getElementById('emulator');

            async function initEmulator() {
                try {
                    if (customElements.get('snes-emulator') === undefined) {
                        await customElements.whenDefined('snes-emulator');
                    }
                    statusEl.textContent = 'Emulator ready.';

                    // Attach a safe afterRun listener if the element dispatches it.
                    emuEl.addEventListener('afterRun', () => {
                        // Keep this minimal: just flip a status dot when running frames.
                        statusEl.textContent = 'Emulator running â€” frame updated at ' + new Date().toLocaleTimeString();
                    });

                    // Provide a simple UI method to get a save state if the element exposes it.
                    // This avoids assuming internal emulator structure.
                    window.getEmulatorSaveState = () => {
                        if (typeof emuEl.getSaveState === 'function') return emuEl.getSaveState();
                        return null;
                    };
                } catch (err) {
                    statusEl.textContent = 'Emulator failed to initialize: ' + err.message;
                    console.error(err);
                }
            }

            initEmulator();
                
        </script>
    </body>
</html>
